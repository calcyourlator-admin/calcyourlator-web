name: Update Mortgage Rates

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch: # Allows manual trigger

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Fetch Dual FRED Data
        run: |
          mkdir -p public
          # Fetch 30-year rate
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=MORTGAGE30US&api_key=${{ secrets.FRED_API_KEY }}&file_type=json&limit=1&sort_order=desc" > 30yr.json
          # Fetch 15-year rate
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=MORTGAGE15US&api_key=${{ secrets.FRED_API_KEY }}&file_type=json&limit=1&sort_order=desc" > 15yr.json
          
          # Merge both into the public rates.json file
          echo "{\"MORTGAGE30US\": $(cat 30yr.json), \"MORTGAGE15US\": $(cat 15yr.json)}" > public/rates.json

      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CALCYOURLATOR_SITE }}

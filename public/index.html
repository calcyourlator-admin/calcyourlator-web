<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Calculator: Estimate Monthly Payments with Live 2026 FRED Rates</title>
    <meta name="description"
        content="Professional financial calculators for 2026. Estimate mortgage PITI, rent vs. buy breakeven, and auto loan TCO with live FRED data handshake and institutional transparency.">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
        crossorigin="anonymous"></script>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Calcyourlator" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#0056b3" />

    <!-- Social Media Meta Tags (OpenGraph) -->
    <meta property="og:title" content="Calcyourlator: Institutional-Grade Financial Modeling Engine" />
    <meta property="og:description"
        content="Calculate mortgage PITI, Rent vs. Buy wealth gaps, and Auto Loan TCO with live FRED® data. Unbiased financial analysis." />
    <meta property="og:image" content="https://calcyourlator.com/og-image.jpg" />
    <meta property="og:url" content="https://calcyourlator.com" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bk-blue': '#0056b3', // Bankrate Primary
                        'bk-text': '#212529',
                        'bk-sidebar': '#f8f9fa',
                        'bk-white': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            color: #212529;
            background-color: #ffffff;
        }

        .main-grid-container {
            display: flex;
            align-items: flex-start;
            gap: 2.5rem;
            justify-content: center;
            max-width: 1280px !important;
            margin-left: auto !important;
            margin-right: auto !important;
            padding: 0 20px !important;
            width: 100%;
        }



        .sidebar-card {
            width: 100% !important;
            box-sizing: border-box !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .left-column {
            flex: 1 !important;
            max-width: 650px !important;
            min-width: 0;
        }

        .right-pillar-sidebar {
            width: 440px !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
        }

        .sidebar-ad-container {
            height: 100px !important;
            max-height: 100px !important;
            overflow: hidden !important;
            margin-bottom: 20px;
        }

        /* Custom Inputs */
        .bk-input {
            width: 100%;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: #212529;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .bk-input:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 86, 179, 0.25);
        }

        .bk-label {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            display: block;
        }

        /* Tabs */
        .bk-tab {
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: #6c757d;
            border-bottom: 4px solid transparent;
            cursor: pointer;
            transition: color 0.2s;
        }

        .bk-tab.active {
            color: #0056b3;
            border-bottom-color: #0056b3;
        }

        .bk-tab:hover:not(.active) {
            color: #495057;
        }

        /* Zebra Table */
        .am-table th {
            background-color: #f1f3f5;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #495057;
            padding: 0.75rem;
            text-align: left;
        }

        .am-table td {
            padding: 0.75rem;
            border-top: 1px solid #dee2e6;
            font-size: 0.875rem;
            color: #212529;
        }

        .am-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .am-table tbody tr:hover {
            background-color: #e9ecef;
        }

        /* Surgical Fix: Force column centering and eliminate clipping */
        .am-table th:first-child,
        .am-table td:first-child,
        .am-table th:last-child,
        .am-table td:last-child {
            text-align: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        .am-table {
            table-layout: fixed !important;
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 1023px) {
            .main-grid-container {
                flex-direction: column;
                align-items: center;
                gap: 1.5rem;
            }

            .left-column,
            .right-pillar-sidebar {
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        @media (min-width: 1024px) {
            aside {
                position: sticky;
                top: 20px;
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1.5rem !important;
                height: fit-content;
            }
        }

        .is-visible {
            display: table-row !important;
        }

        /* Monetization Layers */
        #header-ad-hub {
            width: 728px;
            height: 90px;
            background-color: #ececec;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        @media (max-width: 992px) {
            #header-ad-hub {
                display: none;
            }

            .nav-container {
                justify-content: center !important;
            }
        }

        /* Lender Marketplace */
        #lender-marketplace,
        #lender-marketplace-rb,
        #auto-lender-marketplace {
            width: 100%;
            background-color: #F8F9FA;
            padding: 2.5rem 0;
            margin: 3rem 0;
            position: relative;
            display: block;
            clear: both;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .lender-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .lender-card {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 1.25rem 1rem;
            border-radius: 0.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .lender-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #dbeafe;
        }

        .lender-logo {
            width: 60px;
            height: 60px;
            background-color: #f3f4f6;
            border-radius: 50%;
            margin-bottom: 0.75rem;
        }

        .lender-btn {
            background-color: #0056b3;
            color: white;
            font-size: 0.875rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            margin-top: auto;
            width: 100%;
            transition: background-color 0.15s;
        }

        .lender-btn:hover {
            background-color: #004494;
        }

        @media (max-width: 768px) {
            .lender-row {
                flex-direction: column;
            }

            .lender-card {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }

            .lender-btn {
                width: auto;
                margin-top: 0;
            }

            .lender-logo {
                margin-bottom: 0;
                margin-right: 1rem;
            }

            #lender-marketplace {
                padding: 1.5rem 0;
            }
        }

        /* Mobile Table Legibility Fix */
        @media (max-width: 768px) {
            .am-table {
                min-width: 650px !important;
                /* Forces legible column width */
                table-layout: fixed !important;
                width: auto !important;
            }

            .am-table th,
            .am-table td {
                padding-left: 4px !important;
                padding-right: 4px !important;
                font-size: 10px !important;
                /* Optimizes for data density */
            }
        }

        @media print {
            body {
                font-size: 11pt;
            }

            nav,
            #header-ad-hub,
            #header-ad-zone,
            .bk-tab,
            #mortgageInputs,
            #autoInputs,
            #rbInputs,
            #amortizationSection,
            aside,
            #edu-mortgage,
            #edu-rentbuy,
            #edu-auto,
            #lender-marketplace,
            #lender-marketplace-rb,
            #auto-lender-marketplace,
            #edu-auto,
            footer,
            #disclosure-modal,
            .mt-4.border-t.border-gray-100.pt-2,
            #edu-mortgage,
            #edu-rentbuy,
            #edu-auto,
            .sidebar-card:not(#resultsCard):not(#rbVerdictCard),
            hr,
            br {
                display: none !important;
            }

            .main-grid-container {
                display: block !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .left-column {
                width: 100% !important;
                max-width: none !important;
            }

            #rbReportContainer {
                display: block !important;
            }

            .no-print {
                display: none !important;
            }

            @page {
                margin: 0.5in;
            }
        }
    </style>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Calcyourlator Mortgage & Rent vs. Buy Engine",
      "operatingSystem": "All",
      "applicationCategory": "FinanceApplication",
      "description": "Institutional-grade mortgage and rent vs. buy calculator utilizing live FRED® economic data for unbiased financial projections.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>
</head>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebApplication",
      "name": "Calcyourlator",
      "url": "https://calcyourlator.com",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "All",
      "abstract": "Institutional-grade financial calculators featuring live FRED data integration for mortgage, rent vs. buy, and auto loan analysis.",
      "browserRequirements": "Requires JavaScript",
      "author": {
        "@type": "Organization",
        "name": "Calcyourlator"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://calcyourlator.com/?tab={tab}&hp={hp}&dp={dp}&r={r}&t={t}&tax={tax}&ins={ins}&rent={rent}",
        "query-input": "required name=tab"
      }
    },
    {
      "@type": "FinancialProduct",
      "name": "Mortgage Calculator",
      "description": "Calculate monthly PITI payments using live Federal Reserve (FRED) interest rates and institutional amortization logic.",
      "feesAndCommissionsSpecification": "https://calcyourlator.com/disclosure"
    },
    {
      "@type": "FinancialProduct",
      "name": "Rent vs. Buy Comparison",
      "description": "Comprehensive 30-year wealth projection comparing homeownership costs against rental opportunity costs with live FRED benchmarks."
    },
    {
      "@type": "FinancialProduct",
      "name": "Auto Loan Calculator",
      "description": "Vehicle loan and Total Cost of Ownership (TCO) calculator featuring fixed-rate amortization and 0% interest logic."
    }
  ]
}
</script>

<body class="flex flex-col min-h-screen">

    <!-- NAV -->
    <nav class="bg-white border-b border-gray-200 overflow-hidden" style="max-height: 100px;">
        <div class="max-w-[1280px] mx-auto px-4 h-[100px] flex items-center justify-between nav-container">
            <a href="index.html" class="flex items-center" style="text-decoration: none;">
                <div class="bg-bk-blue text-white font-black text-xl px-2 py-1 rounded mr-2">C</div>
                <span class="font-extrabold text-xl tracking-tight text-bk-blue">Calcyour<span
                        class="text-green-600">lator</span></span>
            </a>

            <!-- Header Ad Zone -->
            <div id="header-ad-hub">
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <!-- Calculator_Cell_1 -->
                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2949207595448686"
                    data-ad-slot="2628843667" data-ad-format="auto" data-full-width-responsive="true"></ins>
                <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </nav>

    <!-- TABS -->
    <div class="border-b border-gray-200 bg-white">
        <div class="max-w-7xl mx-auto px-4 flex overflow-x-auto">
            <button id="tabMortgage" class="bk-tab active">Mortgage</button>
            <button id="tabRentBuy" class="bk-tab">Rent versus Buy Comparison</button>
            <button id="tabAuto" class="bk-tab">Auto Loan</button>
        </div>
    </div>

    <!-- MAIN STAGE: INPUTS & RESULTS -->
    <div class="main-grid-container max-w-7xl mx-auto px-4 w-full">
        <main class="left-column flex-1 w-full flex flex-col py-6 lg:py-8 space-y-8">

            <!-- INPUT CARD -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h2 class="text-xl font-bold mb-4 text-bk-text" id="inputTitle">Loan Details</h2>

                <!-- MORTGAGE INPUTS -->
                <div id="mortgageInputs" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="bk-label">Home Price</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                <input type="number" id="homePrice" class="bk-input pl-7" value="300000"
                                    aria-label="Home Purchase Price in USD">
                            </div>
                        </div>
                        <div>
                            <label class="bk-label">Down Payment (<span id="dpPercent">20%</span>)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                <input type="number" id="downPayment" class="bk-input pl-7" value="60000"
                                    aria-label="Down Payment Amount in USD">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="bk-label">Interest Rate</label>
                            <div class="relative">
                                <input type="number" id="interestRate" class="bk-input pr-8" step="0.01" value="6.5"
                                    aria-label="Annual Mortgage Interest Rate Percentage">
                                <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                            </div>
                            <p class="text-xs text-green-600 mt-1" id="rateSource">
                                Loading live rates... <span class="text-gray-400 font-normal ml-1" id="rateDate"></span>
                            </p>
                        </div>
                        <div>
                            <label class="bk-label">Loan Term (Years)</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button
                                    class="term-btn py-2 text-sm font-bold border rounded bg-white text-gray-600 hover:bg-gray-50 active"
                                    data-val="30">30</button>
                                <button
                                    class="term-btn py-2 text-sm font-bold border rounded bg-white text-gray-600 hover:bg-gray-50"
                                    data-val="20">20</button>
                                <button
                                    class="term-btn py-2 text-sm font-bold border rounded bg-white text-gray-600 hover:bg-gray-50"
                                    data-val="15">15</button>
                                <button
                                    class="term-btn py-2 text-sm font-bold border rounded bg-white text-gray-600 hover:bg-gray-50"
                                    data-val="10">10</button>
                            </div>
                            <input type="hidden" id="loanTerm" value="30">
                        </div>
                    </div>
                    <!-- Start Date Picker -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="bk-label">Start Date</label>
                            <input type="month" id="startDate" class="bk-input w-full" min="">
                            <p id="loanSummary" class="text-xs text-gray-400 mt-1 font-medium"></p>
                        </div>
                    </div>
                    <!-- Advanced Toggle -->
                    <div class="pt-4 border-t border-gray-200">
                        <button class="text-sm font-bold text-bk-blue hover:underline mb-2"
                            onclick="document.getElementById('advInputs').classList.toggle('hidden')">
                            + Advanced (Tax, Ins, HOA, PMI)
                        </button>
                        <div id="advInputs" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4">
                            <div>
                                <label class="bk-label text-xs">Prop Tax /yr (%)</label>
                                <input type="number" id="propertyTax" class="bk-input" value="1.2" step="0.1"
                                    aria-label="Annual Property Tax Rate Percentage">
                            </div>
                            <div>
                                <label class="bk-label text-xs">Home Ins /yr ($)</label>
                                <input type="number" id="homeIns" class="bk-input" value="1500">
                            </div>
                            <div>
                                <label class="bk-label text-xs">HOA /mo ($)</label>
                                <input type="number" id="hoa" class="bk-input" value="0">
                            </div>
                            <div>
                                <label class="bk-label text-xs">PMI /yr (%)</label>
                                <input type="number" id="pmiRate" class="bk-input" value="0" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RENT BUY INPUTS (Expanded) -->
                <div id="rbInputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- RENTING COLUMN -->
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <p
                            class="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wide border-b border-gray-200 pb-2">
                            Renting Scenario</p>

                        <div class="space-y-3">
                            <div>
                                <label class="bk-label">Monthly Rent</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                    <input type="number" id="rbRent" class="bk-input pl-7" value="2200"
                                        aria-label="Current Monthly Rent Payment">
                                </div>
                            </div>
                            <div>
                                <label class="bk-label">Annual Rent Increase</label>
                                <div class="relative">
                                    <input type="number" id="rbRentInc" class="bk-input pr-8" value="3" step="0.1">
                                    <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="bk-label">Renter's Insurance ($/mo)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                    <input type="number" id="rbRentIns" class="bk-input pl-7" value="20">
                                </div>
                            </div>
                            <div>
                                <label class="bk-label">Security Deposit ($)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                    <input type="number" id="rbDeposit" class="bk-input pl-7" value="2200">
                                </div>
                            </div>
                            <div>
                                <label class="bk-label">Avg. Invest Return (AIR)</label>
                                <div class="relative">
                                    <input type="number" id="rbInv" class="bk-input pr-8" value="6" step="0.1"
                                        aria-label="Average Investment Return for Opportunity Cost Calculation">
                                    <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1">Opportunity cost rate</p>
                            </div>
                        </div>
                    </div>

                    <!-- BUYING COLUMN -->
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <p
                            class="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wide border-b border-gray-200 pb-2">
                            Buying Scenario</p>

                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="bk-label">Home Price</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbPrice" class="bk-input pl-7" value="400000"
                                            aria-label="Target Home Purchase Price">
                                    </div>
                                </div>
                                <div>
                                    <label class="bk-label">Down Pmt ($)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbDown" class="bk-input pl-7" value="80000">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="bk-label">Rate (%)</label>
                                    <div class="relative">
                                        <input type="number" id="rbRate" class="bk-input pr-8" step="0.01" value="6.5">
                                        <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="bk-label">Term</label>
                                    <select id="rbTerm" class="bk-input">
                                        <option value="30" selected>30 Years</option>
                                        <option value="15">15 Years</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="bk-label">Buy Closing Costs</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbBuyCc" class="bk-input pl-7" value="12000">
                                    </div>
                                </div>
                                <div>
                                    <label class="bk-label">Sell Closing Costs</label>
                                    <div class="relative">
                                        <input type="number" id="rbSellCc" class="bk-input pr-8" value="8" step="0.5">
                                        <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="bk-label">Prop Tax ($/yr)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbTaxAmt" class="bk-input pl-7" value="4800">
                                    </div>
                                </div>
                                <div>
                                    <label class="bk-label">Home Ins ($/yr)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbIns" class="bk-input pl-7" value="1200">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="bk-label">Maint ($/yr)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbMaint" class="bk-input pl-7" value="4000">
                                    </div>
                                </div>
                                <div>
                                    <label class="bk-label">HOA ($/mo)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                        <input type="number" id="rbHoa" class="bk-input pl-7" value="0">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="bk-label">Appreciation</label>
                                    <div class="relative">
                                        <input type="number" id="rbApprec" class="bk-input pr-8" value="3" step="0.1">
                                        <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="bk-label">Marginal Tax</label>
                                    <div class="relative">
                                        <input type="number" id="rbTax" class="bk-input pr-8" value="22" step="1">
                                        <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 mt-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="bk-label mb-0">Analysis Duration (Years)</label>
                            <span class="text-xs" style="color: #000000 !important; font-weight: 700;">Comparing <span
                                    id="rbStayVal">7</span> years</span>
                        </div>
                        <input type="range" id="rbStay"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="30"
                            value="7" oninput="document.getElementById('rbStayVal').innerText = this.value"
                            aria-label="Duration of Analysis in Years">
                        <div
                            class="flex flex-col md:flex-row justify-between items-center mt-4 border-t border-gray-100 pt-2">
                            <p class="text-[10px] text-gray-400 italic">*This tool is optimized for U.S. tax codes and
                                financial standards.</p>
                            <a href="javascript:void(0)" onclick="generateRbReport()"
                                class="text-[11px] font-bold text-bk-blue hover:underline flex items-center"
                                aria-label="Generate and print an Institutional Wealth Analysis Report">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Generate Report
                            </a>
                            <button onclick="copyResultsLink()"
                                class="text-[11px] font-bold text-gray-500 hover:text-bk-blue flex items-center ml-4 transition-colors"
                                id="copyLinkBtn"
                                aria-label="Copy a pre-populated deep-link of these results to the clipboard">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                                    </path>
                                </svg>
                                <span id="copyLinkTxt">Copy Link to Results</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AUTO INPUTS (Hidden) -->
                <div id="autoInputs" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="bk-label">Vehicle Price</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                <input type="number" id="autoPrice" class="bk-input pl-7" value="35000"
                                    aria-label="Vehicle Purchase Price">
                            </div>
                        </div>
                        <div>
                            <label class="bk-label">Down Payment (<span id="autoDpPercent">14.3%</span>)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                                <input type="number" id="autoDown" class="bk-input pl-7" value="5000">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="bk-label">Interest Rate</label>
                            <div class="relative">
                                <input type="number" id="autoRate" class="bk-input pr-8" step="0.1" value="7.5">
                                <span class="absolute right-3 top-2 text-gray-500 font-bold">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="bk-label">Term (Months)</label>
                            <select id="autoTerm" class="bk-input" aria-label="Auto Loan Term in Months">
                                <option value="36">36</option>
                                <option value="48">48</option>
                                <option value="60" selected="">60</option>
                                <option value="72">72</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="bk-label">Ins and Running Costs /mo</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500 font-bold">$</span>
                            <input type="number" id="autoRun" class="bk-input pl-7" value="150">
                        </div>
                    </div>
                </div> <!-- CLOSES autoInputs -->
            </div> <!-- CLOSES MAIN CARD -->

            <details id="amortizationSection"
                class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-8 pt-8 border-t-2 border-t-gray-100">
                <summary
                    class="text-sm font-bold text-bk-blue cursor-pointer uppercase tracking-wide hover:underline list-none flex items-center">
                    <span>View Full Amortization Schedule</span>
                    <svg class="w-3 h-3 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>
                <div class="mt-4 flex justify-between items-center mb-2">
                    <button id="toggleAllYears"
                        class="text-[10px] font-bold text-bk-blue uppercase tracking-widest hover:underline flex items-center">
                        Expand All Years
                    </button>
                    <span id="loanEndTxt" class="text-[10px] text-gray-500 font-bold uppercase tracking-widest"></span>
                </div>
                <div class="overflow-x-auto max-h-[600px] border border-gray-200 rounded-lg scrollbar-thin">
                    <table class="w-full text-center border-collapse am-table text-xs" style="table-layout: fixed;">
                        <thead>
                            <tr class="bg-blue-50">
                                <th class="sticky top-0 z-10 p-2 font-black text-bk-blue border-b border-gray-200 text-center uppercase tracking-tighter"
                                    style="width: 18.75%; text-align: center; font-size: 11px;">DATE</th>
                                <th class="sticky top-0 z-10 p-2 font-black text-bk-blue border-b border-gray-200 text-center uppercase tracking-tighter"
                                    style="width: 20.3125%; text-align: center; font-size: 11px;">PRINCIPAL</th>
                                <th class="sticky top-0 z-10 p-2 font-black text-bk-blue border-b border-gray-200 text-center uppercase tracking-tighter"
                                    style="width: 20.3125%; text-align: center; font-size: 11px;">INTEREST</th>
                                <th class="sticky top-0 z-10 p-2 font-black text-bk-blue border-b border-gray-200 text-center uppercase tracking-tighter"
                                    style="width: 20.3125%; text-align: center; font-size: 11px;">PMI</th>
                                <th class="sticky top-0 z-10 p-2 font-black text-bk-blue border-b border-gray-200 text-center uppercase tracking-tighter"
                                    style="width: 20.3125%; text-align: center; font-size: 11px;">BALANCE</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
            </details>

        </main>

        <!-- SIDEBAR: RES + ADS + METHODOLOGY (Sticky) -->
        <aside class="right-pillar-sidebar w-full shrink-0 mt-8 lg:mt-0 self-start">

            <!-- RESULTS CARD (Monthly Payment) -->
            <div id="resultsCard" class="sidebar-card p-4 flex flex-col space-y-3">
                <div class="flex justify-between items-center h-4">
                    <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-wide" id="resTitle">Estimated
                        Monthly Payment</h2>
                </div>

                <!-- Main Result -->
                <div class="flex items-baseline text-bk-blue pb-1">
                    <span class="text-3xl font-extrabold" id="bigVal">$0</span>
                    <span class="ml-1 text-base font-medium text-gray-400" id="bigUnit">/mo</span>
                </div>

                <!-- Chart -->
                <div class="relative h-40 mb-2 flex justify-center" id="chartContainer">
                    <canvas id="resultChart"></canvas>
                </div>

                <!-- List Breakdown -->
                <div id="breakdown" class="space-y-1 mb-2"></div>
            </div>

            <!-- AUTO TCO CARD (Auto Only) -->
            <div id="autoTcoCard" class="sidebar-card p-5 hidden bg-blue-50 border-blue-100">
                <p class="text-[10px] font-bold text-bk-blue uppercase tracking-widest mb-1">Total Monthly Cost (TCO)
                </p>
                <div class="text-3xl font-black text-bk-text" id="autoTcoVal">$0</div>
                <p class="text-[10px] text-gray-500 mt-2">Inc. loan + $150 insurance & running costs.</p>
            </div>

            <!-- RENT/BUY VERDICT CARD (RB Only) -->
            <!-- RENT/BUY VERDICT CARD (RB Only) -->
            <div id="rbVerdictCard" class="sidebar-card p-5 hidden bg-white">
                <div id="breakevenBanner"
                    class="bg-bk-blue text-white text-xs font-bold p-3 rounded mb-4 text-center leading-normal">
                    Buying becomes the superior financial choice if you remain in the home for <span id="beYear"
                        class="text-yellow-300 text-lg">X</span> years or longer.
                </div>

                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Net Future Value (NFV)
                    Analysis</h2>
                <p class="text-[10px] text-gray-400 mb-4">Projected wealth after <span id="rbStayTxt">7</span> years.
                </p>

                <div class="grid grid-cols-1 gap-3">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <span class="text-[10px] uppercase font-bold text-green-700 opacity-70">Buying Net Worth</span>
                        <div class="text-xl font-black text-green-700" id="rbBuyNW">$0</div>
                        <div class="text-[10px] text-green-600 mt-1 leading-tight">Equity + Appreciation - Costs</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <span class="text-[10px] uppercase font-bold text-bk-blue opacity-70">Renting Net Worth</span>
                        <div class="text-xl font-bold text-bk-blue" id="rbRentNW">$0</div>
                        <div class="text-[10px] text-bk-blue mt-1 leading-tight opacity-70">Invested Savings @ <span
                                id="rbAirTxt">6</span>%</div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-100 text-center">
                    <p class="text-2xl font-black text-bk-text mb-1" id="rbWinText">Buying Wins</p>
                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Financial Advantage</p>
                </div>
            </div>

            <!-- SIDEBAR MONETIZATION (Tab-Specific) -->
            <div id="side-ad-mortgage" class="sidebar-card p-4">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">Sponsored</p>
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <div class="sidebar-ad-container">
                    <ins class="adsbygoogle" style="display:block; height:100px !important;"
                        data-ad-client="ca-pub-2949207595448686" data-ad-slot="2628843667" data-ad-format="horizontal"
                        data-full-width-responsive="false"></ins>
                </div>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
            <div id="side-ad-rb" class="sidebar-card p-4 hidden">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">Sponsored</p>
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <div class="sidebar-ad-container">
                    <ins class="adsbygoogle" style="display:block; height:100px !important;"
                        data-ad-client="ca-pub-2949207595448686" data-ad-slot="6903130592" data-ad-format="horizontal"
                        data-full-width-responsive="false"></ins>
                </div>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
            <div id="side-ad-auto" class="sidebar-card p-4 hidden">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">Sponsored</p>
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <div class="sidebar-ad-container">
                    <ins class="adsbygoogle" style="display:block; height:100px !important;"
                        data-ad-client="ca-pub-2949207595448686" data-ad-slot="4291068255" data-ad-format="horizontal"
                        data-full-width-responsive="false"></ins>
                </div>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>

            <!-- METHODOLOGY BLOCK -->
            <div class="sidebar-card p-3">
                <details id="methodology-dropdown" class="group">
                    <summary
                        class="text-[10px] font-bold text-gray-500 uppercase tracking-wide cursor-pointer flex items-center hover:text-bk-blue list-none">
                        Calculation Methodology & Accuracy
                        <svg class="w-2.5 h-2.5 ml-1 transform group-open:rotate-180 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </summary>
                    <div
                        class="mt-2 text-[11px] text-gray-700 bg-gray-50 p-2 rounded border border-gray-100 leading-relaxed">
                        <ul class="space-y-3">
                            <li><strong class="text-bk-text">Institutional Alignment:</strong> Our computational logic
                                is designed to align with the regulatory standards utilized by major U.S. financial
                                institutions and the Consumer Financial Protection Bureau (CFPB). This tool serves as an
                                unbiased, third-party baseline for consumers to verify lending estimates against current
                                market data.</li>
                            <li><strong class="text-bk-text">The Mathematical Framework:</strong> We utilize the
                                standard monthly payment formula for all fixed-rate debt calculations:
                                <code
                                    class="block bg-gray-100 p-2 my-1 rounded text-bk-blue font-mono font-bold text-center">M = P [ i(1 + i)^n ] / [ (1 + i)^n – 1 ]</code>
                                (Where M = Monthly Payment, P = Principal borrowed, i = Monthly Interest, and n = Number
                                of Months)
                            </li>
                            <li><strong class="text-bk-text">Data Integrity:</strong> Interest rates are synchronized
                                daily with the Federal Reserve Economic Data (FRED) series MORTGAGE30US and
                                MORTGAGE15US. This ensures every calculation is grounded in the most current, sovereign
                                market averages provided by the Federal Reserve Bank of St. Louis.</li>
                        </ul>
                    </div>
                </details>
            </div>
        </aside>
    </div>

    <!-- EDUCATIONAL SECTION: VISUAL DELINEATOR -->
    <div
        style="border-top: 6px solid #0056b3 !important; width: 100%; max-width: 1280px; margin: 60px auto !important;">
    </div>

    <!-- HOW-TO GUIDE -->
    <div id="edu-mortgage">
        <div class="max-w-[1280px] mx-auto px-5 mb-12">
            <h2 class="text-2xl font-black text-bk-blue mb-6">How to calculate your payments using this tool</h2>
            <ol class="list-decimal list-inside space-y-4 text-gray-700 leading-relaxed font-medium">
                <li><strong class="text-bk-text">Enter the Property Price:</strong> Input the total price of the home
                    you
                    are buying or refinancing.</li>
                <li><strong class="text-bk-text">Set your Down Payment:</strong> Enter your cash-on-hand as a dollar
                    amount
                    or percentage. Reminder: Putting less than 20% down will automatically apply a 0.52% PMI estimate.
                </li>
                <li><strong class="text-bk-text">Select your Loan Term:</strong> Choose between 10, 15, 20, or 30 years
                    to
                    see how the duration impacts your total interest.</li>
                <li><strong class="text-bk-text">Input the Interest Rate:</strong> Adjust the rate to match your
                    pre-approval or current market averages.</li>
                <li><strong class="text-bk-text">Expand Advanced Costs:</strong> Toggle the Taxes, Insurance, and HOA
                    dropdown to refine your total monthly cash outlay.</li>
                <li><strong class="text-bk-text">Review the Amortization Schedule:</strong> Expand the <strong
                        class="text-bk-text">"View Full Amortization Schedule"</strong> section to see a year-by-year
                    and month-by-month breakdown of your equity growth. Use this data to visualize exactly how much of
                    your payment goes toward principal versus interest and to identify the specific date you will reach
                    20% equity to eliminate monthly PMI costs.</li>
                <li><strong class="text-bk-text">Explore Today's Top Rates:</strong> Compare institutional market
                    averages against live lender offers to ensure you are securing the most competitive financing for
                    your property.</li>
            </ol>
        </div>



        <!-- LENDER MARKETPLACE -->
        <div id="lender-marketplace">
            <div class="max-w-[1280px] mx-auto px-5">
                <h3 class="text-xl font-black text-bk-blue mb-6">Explore Today's Top Rates</h3>
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <!-- Calculator_Cell_1 -->
                <ins class="adsbygoogle" style="display:block; max-height:120px; overflow: hidden;"
                    data-ad-client="ca-pub-2949207595448686" data-ad-slot="2628843667" data-ad-format="horizontal"
                    data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <!-- PITI GLOSSARY -->
        <div class="max-w-[1280px] mx-auto px-5 mb-20">
            <h2 class="text-2xl font-black text-bk-blue mb-6">Understanding Mortgage Costs (PITI)</h2>
            <dl class="space-y-4 text-gray-700 leading-relaxed">
                <div>
                    <dt class="font-bold text-bk-text inline">Principal:</dt>
                    <dd class="inline">The core amount you borrowed from your lender. Every payment you make chips away
                        at
                        this balance over time.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Interest:</dt>
                    <dd class="inline">The fee your lender charges for the loan. In the early years of your mortgage, a
                        larger share of your payment goes toward interest.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Property Taxes:</dt>
                    <dd class="inline">Fees collected by your local government to fund schools, roads, and services. We
                        estimate this as a percentage of your home's value.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Homeowners Insurance:</dt>
                    <dd class="inline">A required policy that protects your property against damage. This is often paid
                        as
                        part of your monthly mortgage bill.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">PMI (Private Mortgage Insurance):</dt>
                    <dd class="inline">A protection for the lender if you put down less than 20%. Our calculator handles
                        the
                        "burn-down" logic, removing this cost once you hit 20% equity.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">HOA Fees:</dt>
                    <dd class="inline">Monthly dues paid to a Homeowners Association for the upkeep of shared spaces or
                        community services.</dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- RENT VS BUY STRATEGIC GUIDANCE -->
    <div id="edu-rentbuy" class="hidden">
        <div class="max-w-[1280px] mx-auto px-5 mb-12">
            <h2 class="text-2xl font-black text-bk-blue mb-6">How to Use the Rent vs. Buy Calculator</h2>

            <ol class="list-decimal list-inside space-y-4 text-gray-700 leading-relaxed font-medium">
                <li><strong class="text-bk-text">Step 1: Evaluate Total Transaction Costs:</strong> Enter your Down
                    Payment, Buying Closing Costs, and Selling Closing Costs. This identifies the initial capital
                    required to enter the market and the projected exit fees (which can reach 10% or more of home
                    value), both of which are essential for determining your true "Breakeven Point".</li>
                <li><strong class="text-bk-text">Step 2: Input Homeownership & Tax Variables:</strong> Provide your Loan
                    Term, Property Tax, Home Insurance, and Maintenance Costs. Combine these with your Marginal Tax
                    Rate—this is your federal tax bracket (e.g., 22%)—which the tool uses to calculate the
                    tax-deductibility of your mortgage interest and property taxes, effectively "discounting" your
                    ownership costs compared to renting.</li>
                <li><strong class="text-bk-text">Step 3: Define Growth & Opportunity Assumptions:</strong> Set the Home
                    Appreciation Rate and your Average Investment Return (AIR). AIR represents your "Opportunity
                    Cost"—the potential wealth you miss out on by putting cash into a down payment instead of the stock
                    market or other high-yield assets.</li>
                <li><strong class="text-bk-text">Step 4: Compare with Rental Data:</strong> Input your Monthly Rent,
                    Annual Rent Increase, and Renter's Insurance. Include the Security Deposit to capture the full
                    upfront capital required for the rental path.</li>
                <li><strong class="text-bk-text">Step 5: Analyze the Financial Verdict:</strong> Review the "Staying
                    Length" table and the Net Worth Analysis. Observe the specific year where the growth in home equity
                    and tax savings finally outweighs the costs of renting and the missed investment returns of your
                    down payment.</li>
            </ol>

            <!-- Critical Disclaimer -->
            <div class="mt-8 p-4 bg-gray-50 border-l-4 border-gray-400 text-sm text-gray-600 italic">
                "This calculator evaluates the decision from a purely financial standpoint based on user inputs. It does
                not account for intangible human elements such as the personal value of homeownership or the mobility
                offered by renting. Intended for use by U.S. residents only."
            </div>
        </div>



        <!-- LENDER MARKETPLACE (RB) -->
        <div id="lender-marketplace-rb">
            <div class="max-w-[1280px] mx-auto px-5">
                <h3 class="text-xl font-black text-bk-blue mb-6">Explore Today's Top Rates</h3>
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <!-- Rent_v_buy_page -->
                <ins class="adsbygoogle" style="display:block; max-height:120px; overflow: hidden;"
                    data-ad-client="ca-pub-2949207595448686" data-ad-slot="6903130592" data-ad-format="horizontal"
                    data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <div class="max-w-[1280px] mx-auto px-5 mb-20">
            <h2 class="text-2xl font-black text-bk-blue mb-6">Understanding the rent vs. buy comparison</h2>
            <dl class="space-y-4 text-gray-700 leading-relaxed">
                <div>
                    <dt class="font-bold text-bk-text inline">Equity Growth:</dt>
                    <dd class="inline">This is the portion of your mortgage payment that goes toward owning the home.
                        Unlike rent, this money stays in your "wealth" column.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Maintenance & Ownership Costs:</dt>
                    <dd class="inline">As a homeowner, you are responsible for repairs and taxes. This calculator
                        factors these in to give you a "true" cost comparison.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Appreciation:</dt>
                    <dd class="inline">The amount the home's value is expected to grow over time. This is a key benefit
                        of buying that isn't available to renters.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Opportunity Cost:</dt>
                    <dd class="inline">The potential earnings you miss out on by putting your cash into a down payment
                        rather than investing it elsewhere.</dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- AUTO EDUCATIONAL CONTENT -->
    <div id="edu-auto" class="hidden">
        <div class="max-w-[1280px] mx-auto px-5 mb-12">
            <h2 class="text-2xl font-black text-bk-blue mb-6">How to use this auto loan calculator</h2>
            <ol class="list-decimal list-inside space-y-4 text-gray-700 leading-relaxed font-medium">
                <li><strong class="text-bk-text">Enter Vehicle Price:</strong> Input the total purchase price of the
                    car.</li>
                <li><strong class="text-bk-text">Input Down Payment:</strong> Enter the cash you are paying upfront.
                    Tip: A larger down payment reduces your loan balance and can lower your interest rate.</li>
                <li><strong class="text-bk-text">Set your Interest Rate:</strong> Input the APR you expect to receive.
                    This is heavily influenced by your credit score.</li>
                <li><strong class="text-bk-text">Choose your Loan Term:</strong> Select 36, 48, 60, or 72 months. A
                    shorter term saves you money on interest; a longer term lowers your monthly payment.</li>
                <li><strong class="text-bk-text">Estimate Monthly Running Costs:</strong> Input your projected monthly
                    expenses for fuel, insurance, and routine maintenance. This allows the tool to calculate your
                    <strong class="text-bk-text">Total Cost of Ownership (TCO)</strong>, providing a more realistic
                    picture of your monthly automotive budget beyond just the loan payment.
                </li>
            </ol>
        </div>



        <!-- AUTO LOAN MARKETPLACE -->
        <div id="auto-lender-marketplace">
            <div class="max-w-[1280px] mx-auto px-5">
                <h3 class="text-xl font-black text-bk-blue mb-6">Explore Today's Top Auto Rates</h3>
                <script async
                    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2949207595448686"
                    crossorigin="anonymous"></script>
                <!-- car_loan_page -->
                <ins class="adsbygoogle" style="display:block; max-height:120px; overflow: hidden;"
                    data-ad-client="ca-pub-2949207595448686" data-ad-slot="4291068255" data-ad-format="horizontal"
                    data-full-width-responsive="true"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

        <div class="max-w-[1280px] mx-auto px-5 mb-20">
            <h2 class="text-2xl font-black text-bk-blue mb-6">Understanding your auto loan costs</h2>
            <dl class="space-y-4 text-gray-700 leading-relaxed">
                <div>
                    <dt class="font-bold text-bk-text inline">Principal:</dt>
                    <dd class="inline">The actual amount of money you are borrowing (Vehicle Price minus Down Payment).
                    </dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Interest Rate (APR):</dt>
                    <dd class="inline">The annual cost of borrowing the money. Because auto loans are amortized, you pay
                        more interest in the early months of the loan.</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Term:</dt>
                    <dd class="inline">The length of time you have to repay the loan. Bankrate typically suggests a term
                        of 60 months or fewer to avoid "negative equity".</dd>
                </div>
                <div>
                    <dt class="font-bold text-bk-text inline">Ins and Running Costs /mo:</dt>
                    <dd class="inline">These are the additional monthly expenses of owning a vehicle, such as fuel,
                        insurance, and routine maintenance, which should be factored into your total budget.</dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- LOGIC -->

    <script>
        const S = {
            mode: 'mortgage',
            mp: 300000, mdown: 60000, mdpPct: 20, mrate: 6.85, mterm: 30, mtax: 1.2, mins: 1500, mhoa: 0, mpmi: 0,
            mstart: '',
            ap: 35000, adown: 5000, adpPct: 14.28, arate: 7.5, aterm: 60, arun: 150,
            // RB New Variables
            rr: 2200, rinv: 6, rbRentInc: 3, rbRentIns: 20, rbDeposit: 2200,
            bp: 400000, rbDown: 80000, brate: 6.85, rbTerm: 30, rbBuyCc: 12000, rbSellCc: 8,
            rbTaxAmt: 4800, rbIns: 1200, rbMaint: 4000, rbHoa: 0,
            rbApprec: 3, rbTax: 22, stay: 7
        };
        let FRED_DATA = {
            "MORTGAGE30US": { val: 6.85, date: "Manual Fallback" },
            "MORTGAGE15US": { val: 6.15, date: "Manual Fallback" }
        };
        const el = (id) => document.getElementById(id);
        const fmt = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
        const fmtMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
        const fmtPct = (n, d) => {
            if (n === 0 || d === 0) return "0.0%";
            const p = (n / d * 100).toFixed(1);
            return p.endsWith('.0') ? p.split('.')[0] + '%' : p + '%';
        };
        let chart;
        let isAllExpanded = false;

        function init() {
            const ctx = document.getElementById('resultChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{ data: [], backgroundColor: ['#0056b3', '#28a745', '#adb5bd', '#dee2e6'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
            });

            bindEvents();
            fetchFred();
            updateMeta('mortgage');

            // Default Start Date
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const minMonth = `${y}-${m}`;
            el('startDate').value = minMonth;
            el('startDate').min = minMonth; // Enforce future-only
            S.mstart = minMonth;


            setTerm(30); // Default

            // NPS Initialization
            // NPS Initialization (Removed - buttons are now hardcoded)

            // URL Parameter Parsing (Scenario Sharing)
            parseUrlParams();

            update();
        }

        function bindEvents() {
            ['Mortgage', 'Auto', 'RentBuy'].forEach(k => {
                el('tab' + k).onclick = () => setTab(k.toLowerCase());
            });

            // Anchor Logic: Price Handlers
            el('homePrice').oninput = (e) => {
                S.mp = parseFloat(e.target.value) || 0;
                S.mdown = Math.round(S.mp * (S.mdpPct / 100));
                el('downPayment').value = S.mdown;
                checkPmiThreshold();
                update();
            };

            el('autoPrice').oninput = (e) => {
                S.ap = parseFloat(e.target.value) || 0;
                S.adown = Math.round(S.ap * (S.adpPct / 100));
                el('autoDown').value = S.adown;
                update();
            };

            // Anchor Logic: Down Payment Handlers
            el('downPayment').oninput = (e) => {
                S.mdown = parseFloat(e.target.value) || 0;
                S.mdpPct = S.mp > 0 ? (S.mdown / S.mp) * 100 : 0;
                checkPmiThreshold();
                update();
            };

            el('autoDown').oninput = (e) => {
                S.adown = parseFloat(e.target.value) || 0;
                S.adpPct = S.ap > 0 ? (S.adown / S.ap) * 100 : 0;
                update();
            };

            // General inputs
            document.querySelectorAll('input, select').forEach(i => {
                i.addEventListener('input', update);
            });


            // Rent vs Buy Term Toggle (FRED Sync)
            el('rbTerm').addEventListener('change', (e) => {
                const term = parseInt(e.target.value);
                if (term === 30 && FRED_DATA["MORTGAGE30US"]) {
                    el('rbRate').value = FRED_DATA["MORTGAGE30US"].val;
                } else if (term === 15 && FRED_DATA["MORTGAGE15US"]) {
                    el('rbRate').value = FRED_DATA["MORTGAGE15US"].val;
                }
                update();
            });

            // Term Buttons
            document.querySelectorAll('.term-btn').forEach(b => {
                b.onclick = () => setTerm(b.dataset.val);
            });

            // Global Expand/Collapse Button Logic - Explicit State
            el('toggleAllYears').onclick = () => {
                isAllExpanded = !isAllExpanded; // Toggle state
                const btn = el('toggleAllYears');

                // 1. Update Button Text
                btn.innerText = isAllExpanded ? 'COLLAPSE ALL YEARS' : 'EXPAND ALL YEARS';

                // 2. Force Explicit Display on Monthly Rows
                const allRows = document.querySelectorAll('.month-row');
                allRows.forEach(row => {
                    row.style.display = isAllExpanded ? 'table-row' : 'none';
                    // Clean up classes to ensure no conflict
                    if (isAllExpanded) {
                        row.classList.remove('hidden');
                        row.classList.add('is-visible');
                    } else {
                        row.classList.add('hidden');
                        row.classList.remove('is-visible');
                    }
                });

                // 3. Sync Caret Icons
                const allCarets = document.querySelectorAll('.year-summary svg');
                allCarets.forEach(svg => {
                    if (isAllExpanded) {
                        svg.classList.add('rotate-180');
                    } else {
                        svg.classList.remove('rotate-180');
                    }
                });
            };
        }

        function checkPmiThreshold() {
            if (S.mode !== 'mortgage') return;
            const pct = S.mp > 0 ? (S.mdown / S.mp) * 100 : 0;
            const pmiField = el('pmiRate');
            if (pct < 19.99) { // Using 19.99 to avoid rounding issues
                pmiField.value = "0.52";
            } else {
                pmiField.value = "0";
            }
        }



        function setTab(t) {
            // Force the Methodology dropdown to close on page change
            const methodologyDetails = el('methodology-dropdown');
            if (methodologyDetails) {
                methodologyDetails.open = false;
            }

            S.mode = (t === 'rentbuy') ? 'rb' : t;

            // Tabs
            el('tabMortgage').className = `bk-tab ${t === 'mortgage' ? 'active' : ''}`;
            el('tabAuto').className = `bk-tab ${t === 'auto' ? 'active' : ''}`;
            el('tabRentBuy').className = `bk-tab ${t === 'rentbuy' ? 'active' : ''}`;


            // Sections
            el('mortgageInputs').classList.add('hidden');
            el('autoInputs').classList.add('hidden');
            el('rbInputs').classList.add('hidden');

            // Educational Content
            el('edu-mortgage').classList.add('hidden');
            el('edu-auto').classList.add('hidden');
            el('edu-rentbuy').classList.add('hidden');

            // Sidebar Ads
            el('side-ad-mortgage').classList.add('hidden');
            el('side-ad-rb').classList.add('hidden');
            el('side-ad-auto').classList.add('hidden');

            if (t === 'mortgage') {
                el('mortgageInputs').classList.remove('hidden');
                el('amortizationSection').classList.remove('hidden');
                el('edu-mortgage').classList.remove('hidden');
                el('side-ad-mortgage').classList.remove('hidden');
            }
            if (t === 'auto') {
                el('autoInputs').classList.remove('hidden');
                el('amortizationSection').classList.add('hidden');
                el('edu-auto').classList.remove('hidden');
                el('side-ad-auto').classList.remove('hidden');
            }
            if (t === 'rentbuy') {
                el('rbInputs').classList.remove('hidden');
                el('amortizationSection').classList.add('hidden');
                el('inputTitle').innerText = "Comparison Details";
                el('edu-rentbuy').classList.remove('hidden');
                el('side-ad-rb').classList.remove('hidden');
            } else {
                el('inputTitle').innerText = "Loan Details";
            }

            // Ensure collapsed by default unless user interacts
            el('amortizationSection').open = false;

            updateMeta(t);
            update();
        }

        function updateMeta(t) {
            const titles = {
                'mortgage': 'Mortgage Calculator | Live Rates & Amortization - Calcyourlator',
                'auto': 'Auto Loan Calculator | Monthly Payment & TCO - Calcyourlator',
                'rentbuy': 'Rent vs. Buy Calculator | Net Worth Analysis - Calcyourlator'
            };
            const descs = {
                'mortgage': 'Calculate your monthly mortgage payment with taxes, insurance, and HOA. Updated live with current 30-year fixed rates.',
                'auto': 'Estimate your car loan payment and total cost of ownership (TCO) including running costs.',
                'rentbuy': 'Should you rent or buy? Compare 7-year net worth and find your breakeven point.'
            };

            document.title = titles[t] || titles['mortgage'];
            document.querySelector('meta[name="description"]').setAttribute('content', descs[t] || descs['mortgage']);

            updateSchema(t);
        }

        function updateSchema(t) {
            // Schema update logic temporarily simplified to prevent syntax errors
            // This function will be enhanced in future updates
        }

        function setTerm(y) {
            S.mterm = parseInt(y);
            el('loanTerm').value = y;

            // UI: Toggle Active Button State
            document.querySelectorAll('.term-btn').forEach(b => {
                b.className = (b.dataset.val == y)
                    ? "term-btn py-2 text-sm font-bold border rounded bg-bk-blue text-white border-bk-blue shadow-sm"
                    : "term-btn py-2 text-sm font-bold border rounded bg-white text-gray-600 hover:bg-gray-50";
            });

            // Dual-Rate & Market Average Population Logic
            if (y == 30 && FRED_DATA["MORTGAGE30US"]) {
                el('interestRate').value = FRED_DATA["MORTGAGE30US"].val;
                updateRateLabel(FRED_DATA["MORTGAGE30US"]);
            } else if (y == 20) {
                el('interestRate').value = 6.55;
                updateRateLabel({ date: 'Manual Fallback' });
            } else if (y == 15 && FRED_DATA["MORTGAGE15US"]) {
                el('interestRate').value = FRED_DATA["MORTGAGE15US"].val;
                updateRateLabel(FRED_DATA["MORTGAGE15US"]);
            } else if (y == 10) {
                el('interestRate').value = 5.95;
                updateRateLabel({ date: 'Manual Fallback' });
            } else {
                el('interestRate').value = '';
                el('rateSource').innerText = "Manual Entry Required";
            }

            update();
        }

        function updateRateLabel(data) {
            if (!data.date || data.date === 'Manual Fallback') {
                el('rateSource').innerText = "Market Average Rate";
            } else {
                el('rateSource').innerHTML = `Live FRED Rate: ${data.val}% <span class="text-gray-400 font-normal ml-1" id="rateDate">(${data.date})</span>`;
            }
        }

        async function fetchFred() {
            try {
                // Static Bridge: Fetch nested observations for 30yr and 15yr rates
                const response = await fetch('./rates.json');
                if (!response.ok) throw new Error("Static bridge unavailable");
                const data = await response.json();

                // Parse 30-Year Data
                if (data.MORTGAGE30US && data.MORTGAGE30US.observations && data.MORTGAGE30US.observations[0]) {
                    const obs = data.MORTGAGE30US.observations[0];
                    const val = parseFloat(obs.value);
                    if (!isNaN(val)) FRED_DATA["MORTGAGE30US"] = { val: val, date: obs.date };
                }

                // Parse 15-Year Data
                if (data.MORTGAGE15US && data.MORTGAGE15US.observations && data.MORTGAGE15US.observations[0]) {
                    const obs = data.MORTGAGE15US.observations[0];
                    const val = parseFloat(obs.value);
                    if (!isNaN(val)) FRED_DATA["MORTGAGE15US"] = { val: val, date: obs.date };
                }
            } catch (e) {
                console.log("Using High-Authority Market Averages as Fallback");
            } finally {
                // Refresh UI with current term selection
                setTerm(S.mterm);
                // Sync Rent vs Buy Rate with 30-Year Anchor
                if (FRED_DATA["MORTGAGE30US"] && !new URLSearchParams(window.location.search).has('r')) el('rbRate').value = FRED_DATA["MORTGAGE30US"].val;
            }
        }

        function update() {
            read();
            if (S.mode === 'mortgage') calcMortgage();
            if (S.mode === 'auto') calcAuto();
            if (S.mode === 'rb') calcRb();
        }

        function read() {
            // M
            S.mp = parseFloat(el('homePrice').value) || 0;
            S.mdown = parseFloat(el('downPayment').value) || 0;
            S.mrate = parseFloat(el('interestRate').value) || 0;
            S.mterm = parseInt(el('loanTerm').value) || 30;
            S.mtax = parseFloat(el('propertyTax').value) || 0;
            S.mins = parseFloat(el('homeIns').value) || 0;
            S.mhoa = parseFloat(el('hoa').value) || 0;
            S.mpmi = parseFloat(el('pmiRate').value) || 0;
            S.mstart = el('startDate').value;
            // Auto
            S.ap = parseFloat(el('autoPrice').value) || 0;
            S.adown = parseFloat(el('autoDown').value) || 0;
            S.arate = parseFloat(el('autoRate').value) || 0;
            S.aterm = parseInt(el('autoTerm').value) || 60;
            S.arun = parseFloat(el('autoRun').value) || 0;
            // RB
            S.rr = parseFloat(el('rbRent').value) || 0;
            S.rinv = parseFloat(el('rbInv').value) || 0;
            S.rbRentInc = parseFloat(el('rbRentInc').value) || 0;
            S.rbRentIns = parseFloat(el('rbRentIns').value) || 0;
            S.rbDeposit = parseFloat(el('rbDeposit').value) || 0;

            S.bp = parseFloat(el('rbPrice').value) || 0;
            S.rbDown = parseFloat(el('rbDown').value) || 0;
            S.brate = parseFloat(el('rbRate').value) || 0;
            S.rbTerm = parseInt(el('rbTerm').value) || 30;

            S.rbBuyCc = parseFloat(el('rbBuyCc').value) || 0;
            S.rbSellCc = parseFloat(el('rbSellCc').value) || 0;

            S.rbTaxAmt = parseFloat(el('rbTaxAmt').value) || 0;
            S.rbIns = parseFloat(el('rbIns').value) || 0;
            S.rbMaint = parseFloat(el('rbMaint').value) || 0;
            S.rbHoa = parseFloat(el('rbHoa').value) || 0;

            S.rbApprec = parseFloat(el('rbApprec').value) || 0;
            S.rbTax = parseFloat(el('rbTax').value) || 0;
            S.stay = parseInt(el('rbStay').value) || 7;

            el('dpPercent').innerText = fmtPct(S.mdown, S.mp);
            el('autoDpPercent').innerText = fmtPct(S.adown, S.ap);
        }

        function calcMortgage() {
            const loan = S.mp - S.mdown;
            const r = (S.mrate / 100) / 12;
            const n = S.mterm * 12;
            const pi = (loan > 0 && r > 0) ? (loan * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1) : (loan > 0 ? loan / n : 0);

            const moTax = (S.mp * (S.mtax / 100)) / 12;
            const moIns = S.mins / 12;
            const moPmi = (loan > 0 && S.mdown / S.mp < 0.2) ? (loan * (S.mpmi / 100)) / 12 : 0;
            const total = pi + moTax + moIns + S.mhoa + moPmi;

            renderMain(total, 'Estimated Monthly Payment', true);
            renderChart([pi, moTax, moIns, S.mhoa, moPmi], ['P&I', 'Tax', 'Ins', 'HOA', 'PMI'], ['#0056b3', '#28a745', '#adb5bd', '#dee2e6', '#f59e0b']);
            renderList([
                { l: 'Principal & Interest', v: pi, c: '#0056b3' },
                { l: 'Property Tax', v: moTax, c: '#28a745' },
                { l: 'Home Insurance', v: moIns, c: '#adb5bd' },
                { l: 'HOA Fees', v: S.mhoa, c: '#dee2e6' },
                { l: 'PMI', v: moPmi, c: '#f59e0b' }
            ]);

            el('amortizationSection').classList.remove('hidden');
            renderSchedule(loan, r, pi, n);
            el('resultsCard').classList.remove('hidden');
            el('autoTcoCard').classList.add('hidden');
            el('rbVerdictCard').classList.add('hidden');
        }

        function calcAuto() {
            // 1. Capture Inputs
            // Re-reading for safety and to match snippet structure, but using correct IDs
            const price = parseFloat(el('autoPrice').value) || 0;
            const down = parseFloat(el('autoDown').value) || 0;
            const rate = parseFloat(el('autoRate').value) || 0;
            const months = parseInt(el('autoTerm').value) || 1; // Prevent div by 0 for term
            const running = parseFloat(el('autoRun').value) || 0;

            const principal = price - down;
            let monthlyLoanPayment = 0;

            // 2. Interest Rate Logic Branching
            if (rate > 0) {
                // Standard Amortization Formula 
                const i = (rate / 100) / 12;
                monthlyLoanPayment = principal * (i * Math.pow(1 + i, months)) / (Math.pow(1 + i, months) - 1);
            } else {
                // 0% Interest Case: Simple Principal Division
                monthlyLoanPayment = principal / months;
            }

            // 3. UI Update & TCO Calculation
            const totalMonthly = monthlyLoanPayment + running;

            // Map to existing UI functions
            // "Estimated Monthly Payment" typically refers to the Loan Payment in this context
            renderMain(monthlyLoanPayment, 'Estimated Monthly Payment', true);

            renderChart([monthlyLoanPayment, running], ['Loan', 'Running'], ['#0056b3', '#ffc107']);

            renderList([
                { l: 'Loan Payment', v: monthlyLoanPayment, c: '#0056b3' },
                { l: 'Ins & Running Costs', v: running, c: '#ffc107' }
            ]);

            el('amortizationSection').classList.add('hidden');
            el('resultsCard').classList.remove('hidden');
            el('autoTcoCard').classList.remove('hidden');

            // Update TCO Display
            el('autoTcoVal').innerText = fmt(totalMonthly);

            el('rbVerdictCard').classList.add('hidden');
        }

        function calcRb() {
            // CONSTANTS & VARIABLES FROM INPUTS
            const sellCostPct = S.rbSellCc / 100;

            // WEALTH ACCUMULATION STRATEGY (Differential Cash Flow)
            // 1. Comparison assumes both parties start with the same cash (upFrontBuy).
            //    Starting Cash = S.rbDown + S.rbBuyCc
            // 2. Buyer spends it all on DownPmt + Closing.
            // 3. Renter pays Security Deposit. 
            //    (Rent is paid monthly in the loop, just like Mortgage is paid monthly).
            //    Renter Invests the rest: (StartingCash - Deposit).

            const startingCash = S.rbDown + S.rbBuyCc;
            let rentWealth = startingCash - S.rbDeposit; // Initial Investment Pot

            // INITIALIZE BUYER STATE
            let buyVal = S.bp;
            let loan = S.bp - S.rbDown;
            if (loan < 0) loan = 0;

            // MORTGAGE CALC
            const r = S.brate / 100 / 12;
            const n = S.rbTerm * 12;
            const pi = (loan > 0 && r > 0) ? (loan * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1) : (loan > 0 ? loan / n : 0);

            let currentRent = S.rr;
            let currentMoRent = S.rr;
            let breakevenYear = 31; // Default > 30

            // 30 YEAR SIMULATION LOOP
            for (let year = 1; year <= 30; year++) {
                let yearlyBuyCost = 0;
                let yearlyRentCost = 0;

                // Monthly Processing
                for (let k = 0; k < 12; k++) {
                    // --- BUYER COSTS ---
                    let int = 0;
                    let prin = 0;
                    if (loan > 0) {
                        int = loan * r;
                        prin = pi - int;
                        if (loan < prin) { prin = loan; int = 0; }
                        loan -= prin;
                    }

                    // Monthly Layout: PITI + Maint + HOA - TaxShield
                    const moTax = S.rbTaxAmt / 12;
                    const moIns = S.rbIns / 12;
                    const moMaint = S.rbMaint / 12;
                    const moHoa = S.rbHoa;
                    const taxSave = (int + moTax) * (S.rbTax / 100);

                    const buyOutlay = (loan > 0 ? pi : 0) + moTax + moIns + moMaint + moHoa - taxSave;
                    yearlyBuyCost += buyOutlay;

                    // --- RENTER COSTS ---
                    // Rent + Insurance
                    const rentOutlay = currentMoRent + S.rbRentIns;
                    yearlyRentCost += rentOutlay;

                    // --- WEALTH POT CALCULATION (Monthly Compounding) ---
                    // 1. Grow the pot by AIR (monthly rate)
                    rentWealth *= (1 + (S.rinv / 100 / 12));

                    // 2. Add the difference (Savings or Loss)
                    // If Renting is cheaper (Buy 3000, Rent 2000), Diff = 1000. Renter adds 1000 to pot.
                    // If Buying is cheaper (Buy 2000, Rent 3000), Diff = -1000. Renter removes 1000 from pot (opp cost).
                    rentWealth += (buyOutlay - rentOutlay);
                }

                // EOY Adjustments
                buyVal *= (1 + S.rbApprec / 100);
                currentMoRent *= (1 + S.rbRentInc / 100); // Inflate monthly rent for next year

                // CHECK NET WORTH
                const equity = buyVal - loan;
                const buyNetWorth = equity - (buyVal * sellCostPct);

                // RECORD BREAKEVEN
                if (breakevenYear === 31 && buyNetWorth > rentWealth) {
                    breakevenYear = year;
                }

                // SNAPSHOT FOR SELECTED YEAR
                if (year === S.stay) {
                    el('resultsCard').classList.add('hidden');
                    el('autoTcoCard').classList.add('hidden');
                    el('rbVerdictCard').classList.remove('hidden');

                    el('rbBuyNW').innerText = fmt(buyNetWorth);
                    el('rbRentNW').innerText = fmt(rentWealth);

                    if (buyNetWorth > rentWealth) {
                        el('rbWinText').innerText = "Buying Wins";
                        el('rbWinText').className = "text-2xl font-black text-green-700 mb-1";
                    } else {
                        el('rbWinText').innerText = "Renting Wins";
                        el('rbWinText').className = "text-2xl font-black text-bk-blue mb-1";
                    }

                    el('rbAirTxt').innerText = S.rinv;
                    el('rbStayTxt').innerText = S.stay;
                }
            }

            // HEADER UPDATE
            if (breakevenYear > 30) {
                el('breakevenBanner').innerHTML = "Renting appears to be the superior choice for the next 30+ years based on these inputs.";
            } else {
                el('breakevenBanner').innerHTML = `Buying becomes the superior financial choice if you remain in the home for <span class="text-yellow-300 text-lg">${breakevenYear}</span> years or longer.`;
            }
        }

        function renderMain(val, title, showChart) {
            el('resTitle').innerText = title;
            el('bigVal').innerText = fmt(val);
            el('bigUnit').style.display = 'inline';
            if (showChart) el('chartContainer').style.display = 'flex';
        }

        function renderChart(data, labels, colors) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.data.datasets[0].backgroundColor = colors;
            chart.update();
        }

        function renderList(items) {
            el('breakdown').innerHTML = items.map(i => `
                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-2" style="background:${i.c}"></div>
                        <span class="text-sm font-semibold text-gray-600">${i.l}</span>
                    </div>
                    <span class="font-bold text-bk-text">${fmt(i.v)}</span>
                </div>
            `).join('');
        }

        // Mobile Disclosure Toggle
        window.toggleDisclosure = function (el) {
            const tooltip = el.nextElementSibling;
            tooltip.classList.toggle('active');
        }

        // Close tooltip on outside click
        document.addEventListener('click', function (event) {
            const wrappers = document.querySelectorAll('.disclosure-wrapper');
            wrappers.forEach(wrapper => {
                if (!wrapper.contains(event.target)) {
                    const tooltip = wrapper.querySelector('.disclosure-tooltip');
                    if (tooltip) tooltip.classList.remove('active');
                }
            });
        });



        function generateRbReport() {
            const reportContainer = el('rbReportContainer');
            const winner = el('rbWinText').innerText;
            const financialAdvantage = fmt(Math.abs((parseFloat(el('rbBuyNW').innerText.replace(/[^0-9.-]+/g, "")) || 0) - (parseFloat(el('rbRentNW').innerText.replace(/[^0-9.-]+/g, "")) || 0)));

            // Calculate Averages for the report
            const loan = S.bp - S.rbDown;
            const r = S.brate / 100 / 12;
            const n = S.rbTerm * 12;
            const pi = (loan > 0 && r > 0) ? (loan * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1) : (loan > 0 ? loan / n : 0);
            const avgPiti = fmt(pi + (S.rbTaxAmt / 12) + (S.rbIns / 12) + S.rbHoa);
            const annualApprec = fmt(S.bp * (S.rbApprec / 100));
            const annualRent = fmt(S.rr * 12);

            let verbiage = "";
            if (winner.includes("Buying")) {
                verbiage = `If you buy the home, each year you will spend approximately ${avgPiti} per month while the equity and value of the home is projected to increase by ${annualApprec} annually. By remaining in the home for ${S.stay} years, you achieve a total gain of ${financialAdvantage} compared to renting.`;
            } else {
                verbiage = `If you rent the home, each year you will spend ${annualRent} annually, but you retain your initial ${fmt(S.rbDown)} for other investments. Because the costs of buying and selling exceed your equity growth over ${S.stay} years, renting provides a wealth advantage of ${financialAdvantage}.`;
            }

            const reportHtml = `
                <div class="p-8 border-2 border-bk-blue rounded-xl bg-white">
                    <div class="flex justify-between items-start border-b-2 border-gray-100 pb-6 mb-6">
                        <div>
                            <h1 class="text-3xl font-black text-bk-blue">Buyer vs. Renter Journey</h1>
                            <p class="text-gray-500 font-bold uppercase tracking-widest text-sm mt-1">Calcyourlator Institutional Wealth Report</p>
                        </div>
                        <div class="text-right">
                           <p class="text-sm font-bold text-bk-blue">${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                           <p class="text-[10px] font-bold text-gray-400 mt-1 uppercase">Source: <a href="https://calcyourlator.com" class="text-bk-blue hover:underline">www.calcyourlator.com</a></p>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Executive Summary</h2>
                        <p class="text-lg leading-relaxed text-gray-700">${verbiage}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                             <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Market Baseline</h3>
                             <p class="text-sm text-gray-700">Interest rates synchronized with FRED® series MORTGAGE30US/15US.</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                             <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Institutional Alignment</h3>
                             <p class="text-sm text-gray-700">Logic aligns with CFPB regulatory standards for financial modeling.</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-gray-100">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">The Proof: Standard Monthly Payment Formula</h3>
                        <div class="bg-gray-50 p-4 rounded font-mono text-bk-blue text-center text-lg font-bold">
                            M = P [ i(1 + i)^n ] / [ (1 + i)^n – 1 ]
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 text-center">M = Monthly Payment | P = PrincipalBorrowed | i = Monthly Interest | n = Number of Months</p>
                    </div>
                </div>
            `;

            reportContainer.innerHTML = reportHtml;
            window.print();
        }

        function renderSchedule(loan, rate, pi, months) {
            let bal = loan;
            let html = '';
            const threshold = S.mp * 0.8;

            // Date Logic
            const [startYear, startMonth] = S.mstart.split('-').map(Number);
            const startDate = new Date(startYear, startMonth - 1, 1);

            let currentYear = -1;
            let yearlyPrin = 0;
            let yearlyInt = 0;
            let yearlyPmi = 0;
            let yearlyBal = 0;
            let yearRows = '';

            for (let i = 0; i < months; i++) {
                const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                const year = date.getFullYear();
                const monthStr = date.toLocaleDateString('en-US', { month: 'short' });

                if (currentYear !== -1 && currentYear !== year) {
                    html += renderYearRow(currentYear, yearlyPrin, yearlyInt, yearlyPmi, yearlyBal, yearRows);
                    yearlyPrin = 0; yearlyInt = 0; yearlyPmi = 0; yearRows = '';
                }
                currentYear = year;

                const int = bal * rate;
                const prin = pi - int;
                const pmi = (bal > threshold) ? (loan * (S.mpmi / 100) / 12) : 0;

                bal -= prin;
                if (bal < 0) bal = 0;
                yearlyBal = bal;

                yearlyPrin += prin;
                yearlyInt += int;
                yearlyPmi += pmi;

                const fullStr = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                yearRows += `<tr class="month-row year-${year} hidden bg-gray-50/50">
                    <td class="p-2 text-center font-medium text-gray-400 border-b border-gray-50" style="width: 18.75%;">${fullStr}</td>
                    <td class="p-2 text-center font-semibold border-b border-gray-50" style="width: 20.3125%;">${fmtMoney(prin)}</td>
                    <td class="p-2 text-center border-b border-gray-50" style="width: 20.3125%;">${fmtMoney(int)}</td>
                    <td class="p-2 text-center text-orange-600 border-b border-gray-50" style="width: 20.3125%;">${fmtMoney(pmi)}</td>
                    <td class="p-2 text-center font-bold border-b border-gray-50" style="width: 20.3125%;">${fmtMoney(bal)}</td>
                </tr>`;

                if (i === months - 1 || bal <= 0.01) {
                    html += renderYearRow(currentYear, yearlyPrin, yearlyInt, yearlyPmi, yearlyBal, yearRows);
                    const endStr = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    el('loanEndTxt').innerText = `Ends: ${endStr}`;
                    const loanSum = `${S.mterm} Years (${months} payments)`;
                    el('loanSummary').innerText = loanSum;
                    break;
                }
            }
            el('scheduleBody').innerHTML = html;

            // Re-bind Expand/Collapse events for INDIVIDUAL years
            document.querySelectorAll('.year-summary').forEach(row => {
                row.onclick = () => {
                    const y = row.dataset.year;
                    document.querySelectorAll(`.year-${y}`).forEach(r => {
                        // Toggle individual year visibility with explicit display
                        if (r.style.display === 'none' || r.style.display === '' || r.classList.contains('hidden')) {
                            r.style.display = 'table-row';
                            r.classList.remove('hidden');
                        } else {
                            r.style.display = 'none';
                            r.classList.add('hidden');
                        }
                    });
                    // Toggle Icon for individual year
                    const svg = row.querySelector('svg');
                    if (svg) svg.classList.toggle('rotate-180');
                };
            });

            // Reset Global Expansion State on Recalculation
            isAllExpanded = false;
            el('toggleAllYears').innerText = 'EXPAND ALL YEARS';
        }

        function renderYearRow(year, prin, int, pmi, bal, rows) {
            return `<tr class="year-summary cursor-pointer hover:bg-blue-50 transition-colors bg-gray-100 font-bold" data-year="${year}">
                <td class="p-2 text-bk-blue border-b border-gray-200" style="width: 18.75%;">
                    <div class="flex items-center justify-center w-full">
                        <svg class="w-3 h-3 mr-1 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        ${year}
                    </div>
                </td>
                <td class="p-2 text-center border-b border-gray-200" style="width: 20.3125%;">${fmtMoney(prin)}</td>
                <td class="p-2 text-center border-b border-gray-200" style="width: 20.3125%;">${fmtMoney(int)}</td>
                <td class="p-2 text-center text-orange-600 border-b border-gray-200" style="width: 20.3125%;">${fmtMoney(pmi)}</td>
                <td class="p-2 text-center border-b border-gray-200" style="width: 20.3125%;">${fmtMoney(bal)}</td>
            </tr>` + rows;
        }

        init();
    </script>

    <!-- Institutional E-E-A-T Block & NPS Survey -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="py-6 border-t border-gray-200 text-center">

            <!-- NPS Engagement Hook -->
            <div id="nps-container" class="mb-6">
                <p class="text-[12px] font-bold text-gray-600 mb-3">How helpful was this analysis? (1-10)</p>
                <div class="flex justify-center space-x-1 mb-4" id="nps-buttons">
                    <!-- Hard-coded Buttons for Persistence -->
                    <button type="button" onclick="handleNPS(1, this)"
                        aria-label="Rate this financial analysis as 1 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">1</button>
                    <button type="button" onclick="handleNPS(2, this)"
                        aria-label="Rate this financial analysis as 2 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">2</button>
                    <button type="button" onclick="handleNPS(3, this)"
                        aria-label="Rate this financial analysis as 3 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">3</button>
                    <button type="button" onclick="handleNPS(4, this)"
                        aria-label="Rate this financial analysis as 4 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">4</button>
                    <button type="button" onclick="handleNPS(5, this)"
                        aria-label="Rate this financial analysis as 5 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">5</button>
                    <button type="button" onclick="handleNPS(6, this)"
                        aria-label="Rate this financial analysis as 6 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">6</button>
                    <button type="button" onclick="handleNPS(7, this)"
                        aria-label="Rate this financial analysis as 7 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">7</button>
                    <button type="button" onclick="handleNPS(8, this)"
                        aria-label="Rate this financial analysis as 8 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">8</button>
                    <button type="button" onclick="handleNPS(9, this)"
                        aria-label="Rate this financial analysis as 9 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">9</button>
                    <button type="button" onclick="handleNPS(10, this)"
                        aria-label="Rate this financial analysis as 10 out of 10"
                        class="w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-bk-blue">10</button>
                </div>

                <!-- Viral Share Loop (Hidden by default) -->
                <div id="viral-share-loop" class="hidden animate-fade-in-up">
                    <p class="text-[12px] font-bold text-bk-blue mb-2">We're glad we could help! Share this market
                        baseline with your network:</p>
                    <div class="flex justify-center space-x-4">
                        <!-- X (Twitter) -->
                        <a href="https://twitter.com/intent/tweet?text=Check%20out%20this%20institutional-grade%20Rent%20vs.%20Buy%20analysis%20on%20Calcyourlator%20with%20live%20FRED%20data.&url=https://calcyourlator.com"
                            target="_blank" rel="noopener noreferrer"
                            class="text-gray-400 hover:text-black transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                            </svg>
                        </a>
                        <!-- LinkedIn -->
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://calcyourlator.com"
                            target="_blank" rel="noopener noreferrer"
                            class="text-gray-400 hover:text-[#0077b5] transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                            </svg>
                        </a>
                        <!-- WhatsApp -->
                        <a href="https://api.whatsapp.com/send?text=Check%20out%20this%20institutional-grade%20Rent%20vs.%20Buy%20analysis%20on%20Calcyourlator:%20https://calcyourlator.com"
                            target="_blank" rel="noopener noreferrer"
                            class="text-gray-400 hover:text-[#25D366] transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>

            <p class="text-[10px] uppercase tracking-widest text-gray-500 font-medium leading-relaxed">
                Calculations are indexed and reviewed as a substitute for CSA attestation by the Calcyourlator Admin
                Team.
                Data sourced via <span class="font-bold">FRED® series MORTGAGE30US</span>.
            </p>
        </div>
    </div>

    <!-- GLOBAL FOOTER -->
    <footer class="mt-16" style="background-color: #F9FAFB; padding: 20px 0;">
        <div class="max-w-[1280px] mx-auto px-5 text-center">
            <nav class="flex flex-wrap justify-center items-center gap-6 mb-3" style="min-height: 44px;">
                <a href="index.html" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;">Home</a>
                <a href="about.html" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;">About
                    Us</a>
                <a href="privacy.html" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;">Privacy
                    Policy</a>
                <a href="terms.html" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;">Terms
                    of Use</a>
                <a href="javascript:void(0)" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;"
                    onclick="document.getElementById('disclosure-modal').classList.remove('hidden'); document.getElementById('disclosure-modal').classList.add('flex');">Advertiser
                    Disclosure</a>
                <a href="cookies.html" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;">Cookie
                    Settings</a>
                <a href="contact.html" class="text-xs hover:underline"
                    style="color: #6B7280; padding: 12px 8px; min-height: 44px; display: inline-flex; align-items: center;">Contact
                    Us</a>
            </nav>
            <p class="text-[11px] text-gray-400 mt-3 text-center">
                By using this site, you agree to our Terms of Use and Privacy Policy, including our use of cookies.
            </p>
        </div>
    </footer>

    <!-- Disclosure Modal -->
    <div id="disclosure-modal"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 p-4 font-sans">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 relative">
            <button
                onclick="document.getElementById('disclosure-modal').classList.add('hidden'); document.getElementById('disclosure-modal').classList.remove('flex');"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <h3 class="text-xl font-bold text-bk-blue mb-4">Advertiser Disclosure</h3>
            <p class="text-sm text-gray-700 leading-relaxed">
                calcyourlator.com is an independent, advertising-supported publisher and comparison service. We may
                receive compensation when you click on links or purchase products from our partners. This compensation
                may impact how, where, and in what order products appear. We strive to provide a wide range of offers,
                but we do not include information about every financial product or service available in the market.
            </p>
            <div class="mt-6 text-right">
                <button
                    onclick="document.getElementById('disclosure-modal').classList.add('hidden'); document.getElementById('disclosure-modal').classList.remove('flex');"
                    class="bg-bk-blue text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const currentYear = new Date().getFullYear();
            document.title = `Mortgage Calculator: Estimate Monthly Payments with Live ${currentYear} FRED® Rates`;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.setAttribute('content', `Calculate mortgage PITI and Rent vs. Buy wealth gaps with live ${currentYear} Federal Reserve data. Unbiased, institutional-grade financial modeling.`);
            }
        })();
    </script>
    <div id="rbReportContainer" class="hidden"></div>

    <script>
        // --- Social Sharing & Viral Features ---

        // initNPS() Removed - Buttons are hard-coded for persistence

        function handleNPS(score, btn) {
            const container = document.getElementById('nps-container');
            const loop = document.getElementById('viral-share-loop');
            const allBtns = document.getElementById('nps-buttons').querySelectorAll('button');

            // Reset all buttons
            allBtns.forEach(b => {
                b.className = "w-8 h-8 rounded-full border border-gray-200 text-xs font-bold text-gray-400 bg-white hover:bg-gray-100 transition-colors focus:outline-none";
            });

            // Set selected state
            btn.className = "w-8 h-8 rounded-full border border-bk-blue text-xs font-bold text-white bg-bk-blue transition-colors focus:outline-none";

            // Logic: 9-10 reveals share loop
            if (score >= 9) {
                // Show Viral Share Loop
                loop.classList.remove('hidden');
                loop.classList.add('flex', 'flex-col', 'items-center', 'animate-fade-in-up');
                // Remove any previous thank you message if it exists
                const existingThanks = container.querySelector('.nps-thanks');
                if (existingThanks) existingThanks.remove();
            } else {
                // Hide loop if previously shown
                loop.classList.add('hidden');
                loop.classList.remove('flex', 'flex-col', 'items-center', 'animate-fade-in-up');

                // Simple Thank You (avoid duplicates)
                if (!container.querySelector('.nps-thanks')) {
                    const thankYou = document.createElement('p');
                    thankYou.className = "nps-thanks text-xs font-bold text-gray-500 mt-2 animate-fade-in";
                    thankYou.innerText = "Thank you for your feedback!";
                    container.appendChild(thankYou);
                }
            }
        }

        function copyResultsLink() {
            const params = new URLSearchParams();

            // 1. Identify Mode & Map to 'tab'
            let mode = S.mode;
            let tabVal = mode;
            if (mode === 'rentbuy' || mode === 'rb') tabVal = 'rb';

            params.set('tab', tabVal);

            // 2. Capture Inputs based on Active Mode
            if (mode === 'mortgage') {
                params.set('hp', el('homePrice').value);
                params.set('dp', el('downPayment').value);
                params.set('r', el('interestRate').value);
                params.set('t', el('loanTerm').value);
                params.set('tax', el('propertyTax').value);
                params.set('ins', el('homeIns').value);
                params.set('hoa', el('hoa').value);
                params.set('pmi', el('pmiRate').value);
                params.set('start', el('startDate').value);
            }
            else if (mode === 'auto') {
                params.set('ap', el('autoPrice').value);
                params.set('adp', el('autoDown').value);
                params.set('arate', el('autoRate').value);
                params.set('aterm', el('autoTerm').value);
                params.set('arun', el('autoRun').value);
            }
            else if (mode === 'rb' || mode === 'rentbuy') {
                // Rent vs Buy
                params.set('hp', el('rbPrice').value);
                params.set('dp', el('rbDown').value);
                params.set('r', el('rbRate').value);
                params.set('t', el('rbTerm').value);
                params.set('ccbuy', el('rbBuyCc').value);
                params.set('ccsell', el('rbSellCc').value);
                params.set('tax', el('rbTaxAmt').value);
                params.set('ins', el('rbIns').value);
                params.set('maint', el('rbMaint').value);
                params.set('hoa', el('rbHoa').value);
                params.set('app', el('rbApprec').value);
                params.set('mtax', el('rbTax').value);

                params.set('rent', el('rbRent').value);
                params.set('rinc', el('rbRentInc').value);
                params.set('rins', el('rbRentIns').value);
                params.set('dep', el('rbDeposit').value);
                params.set('inv', el('rbInv').value);

                params.set('stay', el('rbStay').value);
            }

            const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;

            navigator.clipboard.writeText(url).then(() => {
                const btnTxt = document.getElementById('copyLinkTxt');
                const original = btnTxt.innerText;
                btnTxt.innerText = "Copied!";
                btnTxt.classList.add('text-green-600');

                setTimeout(() => {
                    btnTxt.innerText = original;
                    btnTxt.classList.remove('text-green-600');
                }, 2000);
            });
        }

        function parseUrlParams() { console.log('Legacy parser disabled.'); }

        // Add fade-in animation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
            .animate-fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        `;
        document.head.appendChild(style);

    </script>

    <script>
        // Fail-Safe Deep Link Parser
        window.addEventListener('load', () => {
            console.log("Calcyourlator: Initializing Deep Link Parser...");
            const urlParams = new URLSearchParams(window.location.search);

            // Support 'tab' (new) and 'mode' (legacy)
            let targetTab = urlParams.get('tab') || urlParams.get('mode');

            if (targetTab) {
                console.log("Target Tab Detected:", targetTab);

                // Normalize alias
                if (targetTab === 'rb') targetTab = 'rentbuy';

                // 1. Force the Tab Switch
                if (typeof setTab === "function") {
                    setTab(targetTab);
                    console.log("Tab Switched to:", targetTab);
                }

                // 2. Inject Values with Error Checking
                // We define maps for each mode to ensure we target the right IDs
                let paramMap = {};

                if (targetTab === 'mortgage') {
                    paramMap = {
                        'hp': 'homePrice',
                        'dp': 'downPayment',
                        'r': 'interestRate',
                        't': 'loanTerm',
                        'tax': 'propertyTax',
                        'ins': 'homeIns',
                        'hoa': 'hoa',
                        'pmi': 'pmiRate',
                        'start': 'startDate'
                    };
                } else if (targetTab === 'auto') {
                    paramMap = {
                        'ap': 'autoPrice',
                        'adp': 'autoDown',
                        'arate': 'autoRate',
                        'aterm': 'autoTerm',
                        'arun': 'autoRun'
                    };
                } else if (targetTab === 'rentbuy' || targetTab === 'rb') {
                    paramMap = {
                        'hp': 'rbPrice',
                        'dp': 'rbDown',
                        'r': 'rbRate',
                        't': 'rbTerm',
                        'rent': 'rbRent',
                        'rinc': 'rbRentInc',
                        'rins': 'rbRentIns',
                        'dep': 'rbDeposit',
                        'inv': 'rbInv',
                        'stay': 'rbStay',
                        'ccbuy': 'rbBuyCc',
                        'ccsell': 'rbSellCc',
                        'tax': 'rbTaxAmt',
                        'ins': 'rbIns',
                        'maint': 'rbMaint',
                        'hoa': 'rbHoa',
                        'app': 'rbApprec',
                        'mtax': 'rbTax'
                    };
                }

                for (const [key, id] of Object.entries(paramMap)) {
                    if (urlParams.has(key)) {
                        const inputElement = document.getElementById(id);
                        if (inputElement) {
                            inputElement.value = urlParams.get(key);
                            console.log(`Injected ${key}: ${urlParams.get(key)} into ${id}`);

                            // Handle specific UI updates like sliders/text sync
                            if (id === 'rbStay') {
                                const disp = document.getElementById('rbStayVal');
                                if (disp) disp.innerText = urlParams.get(key);
                            }
                            if (id === 'loanTerm') {
                                document.querySelectorAll('.term-btn').forEach(b => {
                                    if (b.dataset.val === urlParams.get(key)) b.click(); // Click to trigger style
                                });
                            }
                        } else {
                            console.warn(`Target element ${id} not found for key ${key}`);
                        }
                    }
                }

                // Deep Link Protection Logic (from previous step)
                // If 'r' is present, we ensure FRED logic doesn't overwrite it.
                // (This is implicitly handled because we set value AFTER load, but FRED fetch is async.
                // The previous fix added a check in fetchFred to respect URL params.
                // Here we just set the value. If fetchFred comes later, the check should protect it.)

                // 3. Force the Calculation Update
                if (typeof update === "function") {
                    update();
                    console.log("Calculations Updated.");
                }
                console.log("Deep Link Population Complete.");
            }
        });
    </script>

</body>

</html>
